{
  "id": "1ea13e8c-03ea-409b-877d-ce5c3d2c1cb3",
  "name": "ADFS Database Named Pipe Connection By Uncommon Tool",
  "description": "Detects suspicious local connections via a named pipe to the AD FS configuration database (Windows Internal Database).\nUsed to access information such as the AD FS configuration settings which contains sensitive information used to sign SAML tokens.\n",
  "source": {
    "type": "sigma",
    "id": "1ea13e8c-03ea-409b-877d-ce5c3d2c1cb3",
    "url": "https://github.com/SigmaHQ/sigma/blob/master/pipe_created_adfs_namedpipe_connection_uncommon_tool.yml",
    "file_path": "tmp/repos/sigma/rules/windows/pipe_created/pipe_created_adfs_namedpipe_connection_uncommon_tool.yml"
  },
  "tags": [
    "attackcollection",
    "attackt1005"
  ],
  "author": "Roberto Rodriguez @Cyb3rWard0g",
  "references": [
    "https://github.com/Azure/Azure-Sentinel/blob/f99542b94afe0ad2f19a82cc08262e7ac8e1428e/Detections/SecurityEvent/ADFSDBNamedPipeConnection.yaml",
    "https://o365blog.com/post/adfs/",
    "https://github.com/Azure/SimuLand"
  ],
  "severity": "medium",
  "type": "sigma",
  "status": "test",
  "created": "2021-10-08",
  "modified": "2023-11-30",
  "mitre": {
    "tactics": [
      "TA1005"
    ],
    "techniques": []
  },
  "detection": {
    "query": "selection: {\"PipeName\": \"\\\\MICROSOFT##WID\\\\tsql\\\\query\"}\nfilter_main_generic: {\"Image|endswith\": [\":\\\\Windows\\\\System32\\\\mmc.exe\", \":\\\\Windows\\\\system32\\\\svchost.exe\", \":\\\\Windows\\\\System32\\\\wsmprovhost.exe\", \":\\\\Windows\\\\SysWOW64\\\\mmc.exe\", \":\\\\Windows\\\\SysWOW64\\\\wsmprovhost.exe\", \":\\\\Windows\\\\WID\\\\Binn\\\\sqlwriter.exe\", \"\\\\AzureADConnect.exe\", \"\\\\Microsoft.Identity.Health.Adfs.PshSurrogate.exe\", \"\\\\Microsoft.IdentityServer.ServiceHost.exe\", \"\\\\Microsoft.Tri.Sensor.exe\", \"\\\\sqlservr.exe\", \"\\\\tssdis.exe\"]}",
    "condition": "selection and not 1 of filter_main_*",
    "fields": []
  },
  "falsepositives": [
    "Unknown"
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": [
    "windows",
    "pipe_created"
  ]
}