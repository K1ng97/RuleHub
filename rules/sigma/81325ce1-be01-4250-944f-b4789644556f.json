{
  "id": "81325ce1-be01-4250-944f-b4789644556f",
  "name": "Schedule Task Creation From Env Variable Or Potentially Suspicious Path Via Schtasks.EXE",
  "description": "Detects Schtask creations that point to a suspicious folder or an environment variable often used by malware",
  "source": {
    "type": "sigma",
    "id": "81325ce1-be01-4250-944f-b4789644556f",
    "url": "https://github.com/SigmaHQ/sigma/blob/master/proc_creation_win_schtasks_env_folder.yml",
    "file_path": "tmp/repos/sigma/rules/windows/process_creation/proc_creation_win_schtasks_env_folder.yml"
  },
  "tags": [
    "attackexecution",
    "attackt1053005"
  ],
  "author": "Florian Roth (Nextron Systems)",
  "references": [
    "https://www.welivesecurity.com/2022/01/18/donot-go-do-not-respawn/",
    "https://www.joesandbox.com/analysis/514608/0/html#324415FF7D8324231381BAD48A052F85DF04",
    "https://blog.talosintelligence.com/gophish-powerrat-dcrat/"
  ],
  "severity": "medium",
  "type": "sigma",
  "status": "test",
  "created": "2022-02-21",
  "modified": "2024-10-28",
  "mitre": {
    "tactics": [
      "TA1053"
    ],
    "techniques": [
      "T005"
    ]
  },
  "detection": {
    "query": "selection_1_create: {\"Image|endswith\": \"\\\\schtasks.exe\", \"CommandLine|contains\": \" /create \"}\nselection_1_all_folders: {\"CommandLine|contains\": [\":\\\\Perflogs\", \":\\\\Users\\\\All Users\\\\\", \":\\\\Users\\\\Default\\\\\", \":\\\\Users\\\\Public\", \":\\\\Windows\\\\Temp\", \"\\\\AppData\\\\Local\\\\\", \"\\\\AppData\\\\Roaming\\\\\", \"%AppData%\", \"%Public%\"]}\nselection_2_parent: {\"ParentCommandLine|endswith\": \"\\\\svchost.exe -k netsvcs -p -s Schedule\"}\nselection_2_some_folders: {\"CommandLine|contains\": [\":\\\\Perflogs\", \":\\\\Windows\\\\Temp\", \"\\\\Users\\\\Public\", \"%Public%\"]}\nfilter_optional_other: [{\"ParentCommandLine|contains\": \"unattended.ini\"}, {\"CommandLine|contains\": \"update_task.xml\"}]\nfilter_optional_team_viewer: {\"CommandLine|contains\": \"/Create /TN TVInstallRestore /TR\"}\nfilter_optional_avira_install: {\"CommandLine|contains|all\": [\"/Create /Xml \\\"C:\\\\Users\\\\\", \"\\\\AppData\\\\Local\\\\Temp\\\\.CR.\", \"Avira_Security_Installation.xml\"]}\nfilter_optional_avira_other: {\"CommandLine|contains|all\": [\"/Create /F /TN\", \"/Xml \", \"\\\\AppData\\\\Local\\\\Temp\\\\is-\", \"Avira_\"], \"CommandLine|contains\": [\".tmp\\\\UpdateFallbackTask.xml\", \".tmp\\\\WatchdogServiceControlManagerTimeout.xml\", \".tmp\\\\SystrayAutostart.xml\", \".tmp\\\\MaintenanceTask.xml\"]}\nfilter_optional_klite_codec: {\"CommandLine|contains|all\": [\"\\\\AppData\\\\Local\\\\Temp\\\\\", \"/Create /TN \\\"klcp_update\\\" /XML \", \"\\\\klcp_update_task.xml\"]}",
    "condition": "( all of selection_1_* or all of selection_2_* ) and not 1 of filter_optional_*",
    "fields": []
  },
  "falsepositives": [
    "Benign scheduled tasks creations or executions that happen often during software installations",
    "Software that uses the AppData folder and scheduled tasks to update the software in the AppData folders"
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": [
    "windows",
    "process_creation"
  ]
}