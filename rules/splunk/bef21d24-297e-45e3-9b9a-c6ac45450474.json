{
  "id": "bef21d24-297e-45e3-9b9a-c6ac45450474",
  "name": "Powershell Remote Services Add TrustedHost",
  "description": "The following analytic detects the execution of a PowerShell script that modifies the 'TrustedHosts' configuration via EventCode 4104. It leverages PowerShell Script Block Logging to identify commands targeting WSMan settings, specifically those altering or concatenating trusted hosts. This activity is significant as it can indicate attempts to manipulate remote connection settings, potentially allowing unauthorized remote access. If confirmed malicious, this could enable attackers to establish persistent remote connections, bypass security protocols, and gain unauthorized access to sensitive systems and data.",
  "source": {
    "type": "splunk",
    "id": "bef21d24-297e-45e3-9b9a-c6ac45450474",
    "url": "https://github.com/splunk/security_content/blob/develop/powershell_remote_services_add_trustedhost.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/powershell_remote_services_add_trustedhost.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Teoderick Contreras, Splunk",
  "references": [
    "https://malpedia.caad.fkie.fraunhofer.de/details/win.darkgate"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`powershell` EventCode=4104  ScriptBlockText = \"*WSMan:\\\\localhost\\\\Client\\\\TrustedHosts*\" ScriptBlockText IN (\"* -Value *\", \"* -Concatenate *\") | fillnull | stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `powershell_remote_services_add_trustedhost_filter`",
    "condition": "To successfully implement this analytic, you will need to enable PowerShell Script Block Logging on some or all endpoints. Additional setup here https://docs.splunk.com/Documentation/UBA/5.0.4.1/GetDataIn/AddPowerShell#Configure_module_logging_for_PowerShell.",
    "fields": []
  },
  "falsepositives": [
    "user and network administrator may used this function to add trusted host."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}