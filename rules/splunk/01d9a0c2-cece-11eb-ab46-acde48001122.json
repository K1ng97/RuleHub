{
  "id": "01d9a0c2-cece-11eb-ab46-acde48001122",
  "name": "Detect WMI Event Subscription Persistence",
  "description": "The following analytic identifies the creation of WMI Event Subscriptions, which can be used to establish persistence or perform privilege escalation. It detects EventID 19 (EventFilter creation), EventID 20 (EventConsumer creation), and EventID 21 (FilterToConsumerBinding creation) from Sysmon logs. This activity is significant because WMI Event Subscriptions can execute code with elevated SYSTEM privileges, making it a powerful persistence mechanism. If confirmed malicious, an attacker could maintain long-term access, escalate privileges, and execute arbitrary code, posing a severe threat to the environment.",
  "source": {
    "type": "splunk",
    "id": "01d9a0c2-cece-11eb-ab46-acde48001122",
    "url": "https://github.com/splunk/security_content/blob/develop/detect_wmi_event_subscription_persistence.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/detect_wmi_event_subscription_persistence.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Michael Haag, Splunk",
  "references": [
    "https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1546.003/T1546.003.md",
    "https://www.eideon.com/2018-03-02-THL03-WMIBackdoors/",
    "https://github.com/trustedsec/SysmonCommunityGuide/blob/master/chapters/WMI-events.md",
    "https://in.security/2019/04/03/an-intro-into-abusing-and-identifying-wmi-event-subscriptions-for-persistence/"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`sysmon` EventID=20 | stats count min(_time) as firstTime max(_time) as lastTime by dest dvc object object_category object_path signature signature_id src status user user_id vendor_product | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `detect_wmi_event_subscription_persistence_filter`",
    "condition": "To successfully implement this search, you need to be ingesting logs with that provide WMI Event Subscription from your endpoints. If you are using Sysmon, you must have at least version 6.0.4 of the Sysmon TA and have enabled EventID 19, 20 and 21. Tune and filter known good to limit the volume.",
    "fields": []
  },
  "falsepositives": [
    "It is possible some applications will create a consumer and may be required to be filtered. For tuning, add any additional LOLBin's for further depth of coverage."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}