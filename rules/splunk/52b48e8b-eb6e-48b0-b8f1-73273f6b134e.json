{
  "id": "52b48e8b-eb6e-48b0-b8f1-73273f6b134e",
  "name": "Windows WPDBusEnum Registry Key Modification",
  "description": "This analytic is used to identify when a USB removable media device is attached to a Windows host. In this scenario we are querying the Endpoint Registry data model to look for modifications to the Windows Portable Device keys HKLM\\SOFTWARE\\Microsoft\\Windows Portable Devices\\Devices\\ or HKLM\\System\\CurrentControlSet\\Enum\\SWD\\WPDBUSENUM\\ . Adversaries and Insider Threats may use removable media devices for several malicious activities, including initial access, execution, and exfiltration.",
  "source": {
    "type": "splunk",
    "id": "52b48e8b-eb6e-48b0-b8f1-73273f6b134e",
    "url": "https://github.com/splunk/security_content/blob/develop/windows_wpdbusenum_registry_key_modification.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/windows_wpdbusenum_registry_key_modification.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Steven Dick",
  "references": [
    "https://attack.mitre.org/techniques/T1200/",
    "https://www.cisa.gov/news-events/news/using-caution-usb-drives",
    "https://www.bleepingcomputer.com/news/security/fbi-hackers-use-badusb-to-target-defense-firms-with-ransomware/"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "| tstats `security_content_summariesonly` min(_time) as firstTime, max(_time) as lastTime, count from datamodel=Endpoint.Registry \nwhere Registry.registry_path IN (\"HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows Portable Devices\\\\Devices\\\\*\",\"HKLM\\\\System\\\\CurrentControlSet\\\\Enum\\\\SWD\\\\WPDBUSENUM\\\\*\") \nAND Registry.registry_value_name =\"FriendlyName\" AND Registry.registry_path=\"*USBSTOR*\" \nby Registry.action Registry.dest Registry.process_guid Registry.process_id Registry.registry_hive Registry.registry_path \nRegistry.registry_key_name Registry.registry_value_data Registry.registry_value_name  \nRegistry.registry_value_type Registry.status Registry.user Registry.vendor_product \n| `drop_dm_object_name(Registry)`\n| eval object_handle = registry_value_data, object_name = replace(mvindex(split(mvindex(split(registry_path, \"??\"),1),\"&amp;\"),2),\"PROD_\",\"\")\n| `security_content_ctime(firstTime)` \n| `security_content_ctime(lastTime)`\n| `windows_wpdbusenum_registry_key_modification_filter`",
    "condition": "To successfully implement this search, you must ingest endpoint logging that tracks changes to the HKLM\\SOFTWARE\\Microsoft\\Windows Portable Devices\\Devices\\ or HKLM\\System\\CurrentControlSet\\Enum\\SWD\\WPDBUSENUM\\ registry keys. Ensure that the field from the event logs is being mapped to the proper fields in the Endpoint.Registry data model.",
    "fields": []
  },
  "falsepositives": [
    "Legitimate USB activity will also be detected. Please verify and investigate as appropriate."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}