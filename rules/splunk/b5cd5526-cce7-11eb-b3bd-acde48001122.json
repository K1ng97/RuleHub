{
  "id": "b5cd5526-cce7-11eb-b3bd-acde48001122",
  "name": "WMI Recon Running Process Or Services",
  "description": "The following analytic identifies suspicious PowerShell script execution via EventCode 4104, where WMI performs an event query to list running processes or services. This detection leverages PowerShell Script Block Logging to capture and analyze script block text for specific WMI queries. This activity is significant as it is commonly used by malware and APT actors to map security applications or services on a compromised machine. If confirmed malicious, this could allow attackers to identify and potentially disable security defenses, facilitating further compromise and persistence within the environment.",
  "source": {
    "type": "splunk",
    "id": "b5cd5526-cce7-11eb-b3bd-acde48001122",
    "url": "https://github.com/splunk/security_content/blob/develop/wmi_recon_running_process_or_services.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/wmi_recon_running_process_or_services.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Teoderick Contreras, Splunk",
  "references": [
    "https://news.sophos.com/en-us/2020/05/12/maze-ransomware-1-year-counting/",
    "https://www.eideon.com/2018-03-02-THL03-WMIBackdoors/",
    "https://github.com/trustedsec/SysmonCommunityGuide/blob/master/chapters/WMI-events.md",
    "https://in.security/2019/04/03/an-intro-into-abusing-and-identifying-wmi-event-subscriptions-for-persistence/"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`powershell` EventCode=4104 ScriptBlockText= \"*SELECT*\" AND (ScriptBlockText=\"*Win32_Process*\" OR ScriptBlockText=\"*Win32_Service*\") | fillnull | stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `wmi_recon_running_process_or_services_filter`",
    "condition": "To successfully implement this analytic, you will need to enable PowerShell Script Block Logging on some or all endpoints. Additional setup here https://docs.splunk.com/Documentation/UBA/5.0.4.1/GetDataIn/AddPowerShell#Configure_module_logging_for_PowerShell.",
    "fields": []
  },
  "falsepositives": [
    "Network administrator may used this command for checking purposes"
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}