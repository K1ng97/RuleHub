{
  "id": "71bfdb13-f200-4c6c-b2c9-a2e07adf437d",
  "name": "WMI Permanent Event Subscription",
  "description": "The following analytic detects the creation of permanent event subscriptions using Windows Management Instrumentation (WMI). It leverages Sysmon EventID 5 data to identify instances where the event consumers are not the expected \"NTEventLogEventConsumer.\" This activity is significant because it suggests an attacker is attempting to achieve persistence by running malicious scripts or binaries in response to specific system events. If confirmed malicious, this could lead to severe impacts such as data theft, ransomware deployment, or other damaging outcomes. Investigate the associated scripts or binaries to identify the source of the attack.",
  "source": {
    "type": "splunk",
    "id": "71bfdb13-f200-4c6c-b2c9-a2e07adf437d",
    "url": "https://github.com/splunk/security_content/blob/develop/wmi_permanent_event_subscription.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/wmi_permanent_event_subscription.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Rico Valdez, Splunk",
  "references": [],
  "severity": "medium",
  "type": "splunk",
  "status": "experimental",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`wmi` EventCode=5861 Binding | rex field=Message \"Consumer =\\s+(?<consumer>[^;|^$]+)\" | search consumer!=\"NTEventLogEventConsumer=\\\"SCM Event Log Consumer\\\"\" | stats count min(_time) as firstTime max(_time) as lastTime by ComputerName, consumer, Message | `security_content_ctime(firstTime)`| `security_content_ctime(lastTime)` | rename ComputerName as dest | `wmi_permanent_event_subscription_filter`",
    "condition": "To successfully implement this search, you must be ingesting the Windows WMI activity logs. This can be done by adding a stanza to inputs.conf on the system generating logs with a title of [WinEventLog://Microsoft-Windows-WMI-Activity/Operational].",
    "fields": []
  },
  "falsepositives": [
    "Although unlikely, administrators may use event subscriptions for legitimate purposes."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}