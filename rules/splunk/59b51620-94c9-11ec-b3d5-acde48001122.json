{
  "id": "59b51620-94c9-11ec-b3d5-acde48001122",
  "name": "Kerberos Pre-Authentication Flag Disabled with PowerShell",
  "description": "The following analytic detects the use of the `Set-ADAccountControl` PowerShell cmdlet with parameters that disable Kerberos Pre-Authentication. It leverages PowerShell Script Block Logging (EventCode=4104) to identify this specific command execution. Disabling Kerberos Pre-Authentication is significant because it allows adversaries to perform offline brute force attacks against user passwords using the AS-REP Roasting technique. If confirmed malicious, this activity could enable attackers to escalate privileges or maintain persistence within an Active Directory environment, posing a severe security risk.",
  "source": {
    "type": "splunk",
    "id": "59b51620-94c9-11ec-b3d5-acde48001122",
    "url": "https://github.com/splunk/security_content/blob/develop/kerberos_pre_authentication_flag_disabled_with_powershell.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/kerberos_pre_authentication_flag_disabled_with_powershell.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Mauricio Velazco, Splunk",
  "references": [
    "https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties",
    "https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html",
    "https://stealthbits.com/blog/cracking-active-directory-passwords-with-as-rep-roasting/"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`powershell` EventCode=4104 (ScriptBlockText = \"*Set-ADAccountControl*\" AND ScriptBlockText=\"*DoesNotRequirePreAuth:$true*\") | fillnull | stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `kerberos_pre_authentication_flag_disabled_with_powershell_filter`",
    "condition": "To successfully implement this analytic, you will need to enable PowerShell Script Block Logging on some or all endpoints. Additional setup here https://docs.splunk.com/Documentation/UBA/5.0.4.1/GetDataIn/AddPowerShell#Configure_module_logging_for_PowerShell.",
    "fields": []
  },
  "falsepositives": [
    "Although unlikely, Administrators may need to set this flag for legitimate purposes."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}