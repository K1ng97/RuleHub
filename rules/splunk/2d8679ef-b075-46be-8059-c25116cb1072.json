{
  "id": "2d8679ef-b075-46be-8059-c25116cb1072",
  "name": "O365 User Consent Denied for OAuth Application",
  "description": "The following analytic identifies instances where a user has denied consent to an OAuth application seeking permissions within the Office 365 environment. This detection leverages O365 audit logs, focusing on events related to user consent actions. By filtering for denied consent actions associated with OAuth applications, it captures instances where users have actively rejected permission requests. This activity is significant as it may indicate users spotting potentially suspicious or unfamiliar applications. If confirmed malicious, it suggests an attempt by a potentially harmful application to gain unauthorized access, which was proactively blocked by the user.",
  "source": {
    "type": "splunk",
    "id": "2d8679ef-b075-46be-8059-c25116cb1072",
    "url": "https://github.com/splunk/security_content/blob/develop/o365_user_consent_denied_for_oauth_application.yml",
    "file_path": "tmp/repos/splunk/detections/cloud/o365_user_consent_denied_for_oauth_application.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Mauricio Velazco, Splunk",
  "references": [
    "https://attack.mitre.org/techniques/T1528/",
    "https://www.microsoft.com/en-us/security/blog/2022/09/22/malicious-oauth-applications-used-to-compromise-email-servers-and-spread-spam/",
    "https://learn.microsoft.com/en-us/azure/active-directory/manage-apps/protect-against-consent-phishing",
    "https://learn.microsoft.com/en-us/defender-cloud-apps/investigate-risky-oauth",
    "https://www.alteredsecurity.com/post/introduction-to-365-stealer",
    "https://github.com/AlteredSecurity/365-Stealer"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`o365_graph` status.errorCode=65004 | rename userPrincipalName as user | rename ipAddress as src_ip | stats min(_time) as firstTime max(_time) as lastTime by user src_ip appDisplayName status.failureReason | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `o365_user_consent_denied_for_oauth_application_filter`",
    "condition": "You must install the Splunk Microsoft Office 365 Add-on and ingest Office 365 events.",
    "fields": []
  },
  "falsepositives": [
    "OAuth applications that require mail permissions may be legitimate, investigate and filter as needed."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}