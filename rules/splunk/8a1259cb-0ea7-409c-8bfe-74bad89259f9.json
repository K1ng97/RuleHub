{
  "id": "8a1259cb-0ea7-409c-8bfe-74bad89259f9",
  "name": "Windows AD ServicePrincipalName Added To Domain Account",
  "description": "The following analytic detects the addition of a Service Principal Name (SPN) to a domain account. It leverages Windows Event Code 5136 and monitors changes to the servicePrincipalName attribute. This activity is significant because it may indicate an attempt to perform Kerberoasting, a technique where attackers extract and crack service account passwords offline. If confirmed malicious, this could allow an attacker to obtain cleartext passwords, leading to unauthorized access and potential lateral movement within the domain environment.",
  "source": {
    "type": "splunk",
    "id": "8a1259cb-0ea7-409c-8bfe-74bad89259f9",
    "url": "https://github.com/splunk/security_content/blob/develop/windows_ad_serviceprincipalname_added_to_domain_account.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/windows_ad_serviceprincipalname_added_to_domain_account.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Mauricio Velazco, Splunk",
  "references": [
    "https://adsecurity.org/?p=3466",
    "https://www.thehacker.recipes/ad/movement/dacl/targeted-kerberoasting",
    "https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-5136",
    "https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/t1208-kerberoasting"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`wineventlog_security` EventCode=5136 AttributeLDAPDisplayName=servicePrincipalName OperationType=\"%%14674\" ObjectClass=user | stats values(ObjectDN) as ObjectDN by _time, Computer, SubjectUserName, AttributeValue | rex field=ObjectDN \"^CN=(?P<user>[a-zA-Z0-9!#$%&'@^_{}~.-]+),\" | rename Computer as dest, SubjectUserName as src_user  | `windows_ad_serviceprincipalname_added_to_domain_account_filter`",
    "condition": "To successfully implement this search, you ned to be ingesting eventcode `5136`. The Advanced Security Audit policy setting `Audit Directory Services Changes` within `DS Access` needs to be enabled. Additionally, a SACL needs to be created for AD objects in order to ingest attribute modifications.",
    "fields": []
  },
  "falsepositives": [
    "A Service Principal Name should only be added to an account when an application requires it. While infrequent, this detection may trigger on legitimate actions. Filter as needed."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}