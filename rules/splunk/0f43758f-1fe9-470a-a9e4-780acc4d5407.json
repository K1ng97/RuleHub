{
  "id": "0f43758f-1fe9-470a-a9e4-780acc4d5407",
  "name": "Windows File Transfer Protocol In Non-Common Process Path",
  "description": "The following analytic detects FTP connections initiated by processes located in non-standard installation paths on Windows systems. It leverages Sysmon EventCode 3 to identify network connections where the process image path does not match common directories like \"Program Files\" or \"Windows\\System32\". This activity is significant as FTP is often used by adversaries and malware, such as AgentTesla, for Command and Control (C2) communications to exfiltrate stolen data. If confirmed malicious, this could lead to unauthorized data transfer, exposing sensitive information and compromising the integrity of the affected host.",
  "source": {
    "type": "splunk",
    "id": "0f43758f-1fe9-470a-a9e4-780acc4d5407",
    "url": "https://github.com/splunk/security_content/blob/develop/windows_file_transfer_protocol_in_non_common_process_path.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/windows_file_transfer_protocol_in_non_common_process_path.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Teoderick Contreras, Splunk",
  "references": [
    "https://malpedia.caad.fkie.fraunhofer.de/details/win.agent_tesla"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`sysmon` EventCode=3 NOT(Image IN(\"*\\\\program files*\", \"*\\\\windows\\\\system32\\\\*\",\"*\\\\windows\\\\SysWOW64\\\\*\")) (DestinationPortName=\"ftp\" OR DestinationPort=21) | stats count min(_time) as firstTime max(_time) as lastTime by action app dest dest_ip dest_port direction dvc protocol protocol_version src src_ip src_port transport user vendor_product process_name process_exec process_guid process_id | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_file_transfer_protocol_in_non_common_process_path_filter`",
    "condition": "To successfully implement this search, you need to be ingesting logs with the process name and sysmon eventcode = 3 connection events from your endpoints. If you are using Sysmon, you must have at least version 6.0.4 of the Sysmon TA.",
    "fields": []
  },
  "falsepositives": [
    "third party application may use this network protocol as part of its feature. Filter is needed."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}