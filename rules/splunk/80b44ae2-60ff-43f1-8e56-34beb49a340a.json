{
  "id": "80b44ae2-60ff-43f1-8e56-34beb49a340a",
  "name": "O365 Exfiltration via File Access",
  "description": "The following analytic detects when an excessive number of files are access from o365 by the same user over a short period of time. A malicious actor may abuse the \"open in app\" functionality of SharePoint through scripted or Graph API based access to evade triggering the FileDownloaded Event. This behavior may indicate an attacker staging data for exfiltration or an insider threat removing organizational data. Additional attention should be take with any Azure Guest (#EXT#) accounts.",
  "source": {
    "type": "splunk",
    "id": "80b44ae2-60ff-43f1-8e56-34beb49a340a",
    "url": "https://github.com/splunk/security_content/blob/develop/o365_exfiltration_via_file_access.yml",
    "file_path": "tmp/repos/splunk/detections/cloud/o365_exfiltration_via_file_access.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Steven Dick",
  "references": [
    "https://attack.mitre.org/techniques/T1567/exfil",
    "https://www.varonis.com/blog/sidestepping-detection-while-exfiltrating-sharepoint-data",
    "https://thedfirjournal.com/posts/m365-data-exfiltration-rclone/"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`o365_management_activity` Operation IN (\"fileaccessed\") UserId!=app@sharepoint NOT SourceFileExtension IN (bmp,png,jpeg,jpg)\n| eval user = replace(mvindex(split(lower(UserId),\"#ext#\"),0),\"_\",\"@\"), user_flat = replace(UserId, \"[^A-Za-z0-9]\",\"_\")\n| where NOT match(SiteUrl,user_flat)\n| stats values(user) as user, latest(ClientIP) as src values(ZipFileName) as file_name, values(Operation) as signature, values(UserAgent) as http_user_agent, dc(SourceFileName) as count, min(_time) as firstTime, max(_time) as lastTime by Workload,UserId,SiteUrl\n| eventstats avg(count) as avg stdev(count) as stdev by Workload\n| rename SiteUrl as file_path,Workload as app\n| where count > 50 AND count > (avg + (3*(stdev))) \n| `security_content_ctime(firstTime)` \n| `security_content_ctime(lastTime)`\n| `o365_exfiltration_via_file_access_filter`",
    "condition": "You must install the Splunk Microsoft Office 365 Add-on and ingest Office 365 management activity events.",
    "fields": []
  },
  "falsepositives": [
    "It is possible that certain file access scenarios may trigger this alert, specifically OneDrive syncing and users accessing personal onedrives of other users. Adjust threshold and filtering as needed."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}