{
  "id": "dc167f8b-3f9d-4460-9c98-8b6e703fd628",
  "name": "Windows EventLog Recon Activity Using Log Query Utilities",
  "description": "This analytic detects EventLog reconnaissance activity using utilities such as `wevtutil.exe`, `wmic.exe`, PowerShell cmdlets like `Get-WinEvent`, or WMI queries targeting `Win32_NTLogEvent`. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names and command-line arguments. These tools are often used by adversaries to extract usernames, IP addresses, session data, and event information for credential access or situational awareness during lateral movement. While these utilities are legitimate, execution with specific arguments or targeting sensitive logs like `Security`, `PowerShell`, or specific EventIDs (e.g., 4624, 4778) can indicate malicious intent. If confirmed malicious, this behavior could allow an attacker to extract sensitive info and potentially have leveraged access or move laterally.\n",
  "source": {
    "type": "splunk",
    "id": "dc167f8b-3f9d-4460-9c98-8b6e703fd628",
    "url": "https://github.com/splunk/security_content/blob/develop/windows_eventlog_recon_activity_using_log_query_utilities.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/windows_eventlog_recon_activity_using_log_query_utilities.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Nasreddine Bencherchali, Splunk",
  "references": [
    "http://blog.talosintelligence.com/2022/09/lazarus-three-rats.html",
    "https://thedfirreport.com/2023/10/30/netsupport-intrusion-results-in-domain-compromise/",
    "https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-144a",
    "https://www.group-ib.com/blog/apt41-world-tour-2021/",
    "https://labs.withsecure.com/content/dam/labs/docs/f-secureLABS-tlp-white-lazarus-threat-intel-report2.pdf",
    "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent",
    "https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-eventlog",
    "https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/wevtutil"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "| tstats `security_content_summariesonly` values(Processes.process) as process\n  min(_time) as firstTime max(_time) as lastTime \n  from datamodel=Endpoint.Processes \n  where (\n    (Processes.process_name IN (\"powershell.exe\", \"pwsh.exe\", \"powershell_ise.exe\") AND Processes.process IN (\"*Get-WinEvent*\", \"*Get-EventLog*\", \"*EventLogQuery*\", \"*.ReadEvent(*\"))\n    OR\n    (Processes.process_name=wevtutil.exe Processes.process IN (\"* qe *\", \"* query-events *\"))\n    OR\n    (Processes.process_name=wmic.exe Processes.process IN (\"*ntevent*\"))\n    OR\n    (Processes.process=\"*Win32_NTLogEvent*\" AND Processes.process=\"*EventCode*\")\n    OR\n    (Processes.process IN (\"*PsLogList*\", \"*Eventquery*\"))\n  ) \n  by \n    Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec\n    Processes.parent_process_guid Processes.parent_process_id Processes.parent_process_name\n    Processes.parent_process_path Processes.process Processes.process_exec Processes.process_guid\n    Processes.process_hash Processes.process_id Processes.process_integrity_level Processes.process_name\n    Processes.process_path Processes.user Processes.user_id Processes.vendor_product\n| `drop_dm_object_name(Processes)`\n| `security_content_ctime(firstTime)` \n| `security_content_ctime(lastTime)` \n| `windows_eventlog_recon_activity_using_log_query_utilities_filter`\n",
    "condition": "The detection is based on data that originates from Endpoint Detection\nand Response (EDR) agents. These agents are designed to provide security-related\ntelemetry from the endpoints where the agent is installed. To implement this search,\nyou must ingest logs that contain the process GUID, process name, and parent process.\nAdditionally, you must ingest complete command-line executions. These logs must\nbe processed using the appropriate Splunk Technology Add-ons that are specific to\nthe EDR product. The logs must also be mapped to the `Processes` node of the `Endpoint`\ndata model. Use the Splunk Common Information Model (CIM) to normalize the field\nnames and speed up the data modeling process.\n",
    "fields": []
  },
  "falsepositives": [
    "System administrators or monitoring tools may legitimately use these utilities to gather logs for troubleshooting or auditing. Filter known admin behavior or monitoring solutions as needed.\n"
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}