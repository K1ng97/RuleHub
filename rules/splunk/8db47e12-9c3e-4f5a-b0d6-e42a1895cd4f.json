{
  "id": "8db47e12-9c3e-4f5a-b0d6-e42a1895cd4f",
  "name": "Windows PowerShell Invoke-RestMethod IP Information Collection",
  "description": "The following analytic detects the use of PowerShell's Invoke-RestMethod cmdlet to collect geolocation data from ipinfo.io or IP address information from api.ipify.org. This behavior leverages PowerShell Script Block Logging to identify scripts that gather external IP information and potential geolocation data. This activity is significant as it may indicate reconnaissance efforts, where threat actors are attempting to determine the geographical location or network details of a compromised system. While some legitimate software may use these services, this pattern is commonly observed in malware and post-exploitation toolkits like those used by Water Gamayun threat actors.",
  "source": {
    "type": "splunk",
    "id": "8db47e12-9c3e-4f5a-b0d6-e42a1895cd4f",
    "url": "https://github.com/splunk/security_content/blob/develop/windows_powershell_invoke_restmethod_ip_information_collection.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/windows_powershell_invoke_restmethod_ip_information_collection.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Michael Haag, Splunk",
  "references": [
    "https://securityintelligence.com/posts/new-threat-actor-water-gamayun-targets-telecom-finance/",
    "https://www.ncsc.gov.uk/report/weekly-threat-report-12th-april-2024"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`powershell` EventCode=4104 (ScriptBlockText=\"*Invoke-RestMethod*\" AND (ScriptBlockText=\"*ipinfo.io*\" OR ScriptBlockText=\"*api.ipify.org*\")) | stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_powershell_invoke_restmethod_ip_information_collection_filter`",
    "condition": "To successfully implement this analytic, you will need to enable PowerShell Script Block Logging on some or all endpoints. Additional setup here https://docs.splunk.com/Documentation/UBA/5.0.4.1/GetDataIn/AddPowerShell#Configure_module_logging_for_PowerShell.",
    "fields": []
  },
  "falsepositives": [
    "Some legitimate applications or administrative scripts may use these services for IP validation or geolocation. Filter as needed for approved administrative tools."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}