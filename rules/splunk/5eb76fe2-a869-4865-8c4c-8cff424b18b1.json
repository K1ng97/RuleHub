{
  "id": "5eb76fe2-a869-4865-8c4c-8cff424b18b1",
  "name": "Windows SQL Server xp_cmdshell Config Change",
  "description": "This detection identifies when the xp_cmdshell configuration is modified in SQL Server. The xp_cmdshell extended stored procedure allows execution of operating system commands and programs from SQL Server, making it a high-risk feature commonly abused by attackers for privilege escalation and lateral movement.",
  "source": {
    "type": "splunk",
    "id": "5eb76fe2-a869-4865-8c4c-8cff424b18b1",
    "url": "https://github.com/splunk/security_content/blob/develop/windows_sql_server_xp_cmdshell_config_change.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/windows_sql_server_xp_cmdshell_config_change.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "manual_test",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Michael Haag, Splunk",
  "references": [
    "https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql",
    "https://attack.mitre.org/techniques/T1505/003/",
    "https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/xp-cmdshell-server-configuration-option"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`wineventlog_application` EventCode=15457 | rex field=EventData_Xml \"<Data>(?<config_name>[^<]+)</Data><Data>(?<new_value>[^<]+)</Data><Data>(?<old_value>[^<]+)</Data>\" | rename host as dest | where config_name=\"xp_cmdshell\" | eval change_type=case( old_value=\"0\" AND new_value=\"1\", \"enabled\", old_value=\"1\" AND new_value=\"0\", \"disabled\", true(), \"modified\" ) | eval risk_score=case( change_type=\"enabled\", 90, change_type=\"disabled\", 60, true(), 70 ) | eval risk_message=\"SQL Server xp_cmdshell was \".change_type.\" on host \".dest | stats count min(_time) as firstTime max(_time) as lastTime by dest EventCode config_name change_type risk_message risk_score | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `windows_sql_server_xp_cmdshell_config_change_filter`",
    "condition": "To successfully implement this detection, you need to be ingesting Windows Application Event Logs from SQL Server instances where SQL Server is installed. The detection specifically looks for EventID 15457 which indicates configuration changes to extended stored procedures.",
    "fields": []
  },
  "falsepositives": [
    "Database administrators may legitimately enable xp_cmdshell for maintenance tasks, such as database maintenance scripts requiring OS-level operations, legacy applications, or automated system management tasks; however, this feature should generally remain disabled in production environments due to security risks. To reduce false positives, document when xp_cmdshell is required, monitor for unauthorized changes, create change control procedures for xp_cmdshell modifications, and consider alerting on the enabled state rather than configuration changes if preferred."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}