{
  "id": "15603165-147d-4a6e-9778-bd0ff39e668f",
  "name": "Windows Unusual Count Of Invalid Users Failed To Auth Using NTLM",
  "description": "The following analytic identifies a source endpoint failing to authenticate with multiple invalid users using the NTLM protocol. It leverages EventCode 4776 and calculates the standard deviation for each host, using the 3-sigma rule to detect anomalies. This behavior is significant as it may indicate a Password Spraying attack, where an adversary attempts to gain initial access or elevate privileges. If confirmed malicious, this activity could lead to unauthorized access or privilege escalation, posing a significant threat to the Active Directory environment. This detection is focused on domain controllers.",
  "source": {
    "type": "splunk",
    "id": "15603165-147d-4a6e-9778-bd0ff39e668f",
    "url": "https://github.com/splunk/security_content/blob/develop/windows_unusual_count_of_invalid_users_failed_to_auth_using_ntlm.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/windows_unusual_count_of_invalid_users_failed_to_auth_using_ntlm.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Mauricio Velazco, Splunk",
  "references": [
    "https://attack.mitre.org/techniques/T1110/003/",
    "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/audit-credential-validation",
    "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4776"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`wineventlog_security` EventCode=4776 TargetUserName!=*$ Status=0xc0000064 | bucket span=2m _time | stats dc(TargetUserName) AS unique_accounts values(TargetUserName) as user values(dest) as dest by _time, Workstation | eventstats avg(unique_accounts) as comp_avg , stdev(unique_accounts) as comp_std by Workstation | eval upperBound=(comp_avg+comp_std*3) | eval isOutlier=if(unique_accounts > 10 and unique_accounts >= upperBound, 1, 0) | search isOutlier=1 | rename Workstation as src |`windows_unusual_count_of_invalid_users_failed_to_auth_using_ntlm_filter`",
    "condition": "To successfully implement this search, you need to be ingesting Domain Controller events. The Advanced Security Audit policy setting `Audit Credential Validation' within `Account Logon` needs to be enabled.",
    "fields": []
  },
  "falsepositives": [
    "A host failing to authenticate with multiple invalid domain users is not a common behavior for legitimate systems. Possible false positive scenarios include but are not limited to vulnerability scanners and missconfigured systems. If this detection triggers on a host other than a Domain Controller, the behavior could represent a password spraying attack against the host's local accounts."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}