{
  "id": "dd7798cf-c4f5-4114-ad0f-beacd9a33708",
  "name": "O365 Email Send and Hard Delete Exfiltration Behavior",
  "description": "The following analytic identifies when an O365 email account sends and then hard deletes an email to an external recipient within a short period (within 1 hour). This behavior may indicate a compromised account where the threat actor is attempting to remove forensic artifacts or evidence of exfiltration activity. This behavior is often seen when threat actors want to reduce the probability of detection by the compromised account owner.",
  "source": {
    "type": "splunk",
    "id": "dd7798cf-c4f5-4114-ad0f-beacd9a33708",
    "url": "https://github.com/splunk/security_content/blob/develop/o365_email_send_and_hard_delete_exfiltration_behavior.yml",
    "file_path": "tmp/repos/splunk/detections/cloud/o365_email_send_and_hard_delete_exfiltration_behavior.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Steven Dick",
  "references": [
    "https://attack.mitre.org/techniques/T1114/",
    "https://www.hhs.gov/sites/default/files/help-desk-social-engineering-sector-alert-tlpclear.pdf",
    "https://intelligence.abnormalsecurity.com/attack-library/threat-actor-convincingly-impersonates-employee-requesting-direct-deposit-update-in-likely-ai-generated-attack"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`o365_messagetrace` Status=Delivered\n| eval mailtime = _time\n| bin _time span=1hr\n| eval user = lower(SenderAddress), recipient = lower(RecipientAddress)\n| eval InternetMessageId = lower(MessageId)\n| join InternetMessageId, user, max=0\n  [\n  | search `o365_management_activity` Workload=Exchange (Operation IN (\"Send*\")) OR (Operation IN (\"HardDelete\") AND Folder.Path IN (\"\\\\Sent Items\",\"\\\\Recoverable Items\\\\Deletions\"))\n  | eval user = lower(UserId), sender = lower(CASE(isnotnull(SendAsUserSmtp),SendAsUserSmtp,isnotnull(SendOnBehalfOfUserSmtp),SendOnBehalfOfUserSmtp,true(),MailboxOwnerUPN)), subject = trim(CASE(Operation IN (\"Send\",\"SendAs\",\"SendOnBehalf\"),'Item.Subject',Operation IN (\"SoftDelete\",\"HardDelete\"),'AffectedItems{}.Subject')), -time = _time,file_name = CASE(Operation IN (\"Send\",\"SendAs\",\"SendOnBehalf\"),split('Item.Attachments',\"; \"),Operation IN (\"SoftDelete\",\"HardDelete\"),split('AffectedItems{}.Attachments',\"; \")), file_size = CASE(Operation IN (\"Send\",\"SendAs\",\"SendOnBehalf\"),round(tonumber('Item.SizeInBytes')/1024/1024,2),true(),round(tonumber(replace(file_name, \"(.+)\\s\\((\\d+)(b\\)$)\", \"\\2\"))/1024/1024,2)), InternetMessageId = lower('Item.InternetMessageId')\n  | eval sendtime = CASE(Operation IN (\"Send\",\"SendAs\",\"SendOnBehalf\"),_time)\n  | eval deltime = CASE(Operation IN (\"SoftDelete\",\"HardDelete\"),_time)\n  | bin _time span=1hr\n  | stats values(sender) as sender, values(ClientInfoString) as http_user_agent, values(InternetMessageId) as InternetMessageId, values(file_name) as file_name, sum(file_size) as file_size, values(sendtime) as firstTime, values(deltime) as lastTime values(Operation) as signature, dc(Operation) as opcount, count by _time,subject,user\n  | where opcount > 1 AND firstTime < lastTime\n  ]\n| stats values(sender) as sender, values(http_user_agent) as http_user_agent, values(signature) as signature, values(file_name) as file_name, sum(file_size) as file_size, min(firstTime) as firstTime, max(lastTime) as lastTime  count by subject,user,recipient,Organization\n| eval externalRecipient = if(match(lower(recipient),mvindex(split(lower(Organization),\".\"),0)),0,1)\n| where externalRecipient = 1\n| `security_content_ctime(firstTime)` \n| `security_content_ctime(lastTime)`\n| `o365_email_send_and_hard_delete_exfiltration_behavior_filter`",
    "condition": "You must install the Splunk Microsoft Office 365 Add-on and ingest Office 365 management activity events AND Message Trace events.",
    "fields": []
  },
  "falsepositives": [
    "Users that habitually/proactively cleaning the recoverable items folder may trigger this alert."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}