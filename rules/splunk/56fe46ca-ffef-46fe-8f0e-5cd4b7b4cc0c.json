{
  "id": "56fe46ca-ffef-46fe-8f0e-5cd4b7b4cc0c",
  "name": "Windows Compatibility Telemetry Suspicious Child Process",
  "description": "The following analytic detects the execution of CompatTelRunner.exe with parameters indicative of a process not part of the normal \"Microsoft Compatibility Appraiser\" telemetry collection. It leverages data from Endpoint Detection and Response (EDR) agents, focusing on process names, parent processes, and command-line arguments. This activity is significant because CompatTelRunner.exe and the \"Microsoft Compatibility Appraiser\" task always run as System and can be used to elevate privileges or establish a highly privileged persistence mechanism. If confirmed malicious, this could enable unauthorized code execution, privilege escalation, or persistent access to the compromised system.",
  "source": {
    "type": "splunk",
    "id": "56fe46ca-ffef-46fe-8f0e-5cd4b7b4cc0c",
    "url": "https://github.com/splunk/security_content/blob/develop/windows_compatibility_telemetry_suspicious_child_process.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/windows_compatibility_telemetry_suspicious_child_process.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Steven Dick",
  "references": [
    "https://attack.mitre.org/techniques/T1546/",
    "https://scythe.io/threat-thursday/windows-telemetry-persistence",
    "https://www.trustedsec.com/blog/abusing-windows-telemetry-for-persistence"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "|  tstats `security_content_summariesonly` count min(_time) AS firstTime, max(_time) AS lastTime FROM datamodel=Endpoint.Processes \nwhere Processes.parent_process_name = \"CompatTelRunner.exe\" AND Processes.process=\"* -cv:*\" NOT Processes.process IN (\"* -m:*\") \nby Processes.action Processes.dest Processes.original_file_name Processes.parent_process Processes.parent_process_exec \nProcesses.parent_process_guid Processes.parent_process_id Processes.parent_process_name \nProcesses.parent_process_path Processes.process Processes.process_exec Processes.process_guid Processes.process_hash \nProcesses.process_id Processes.process_integrity_level Processes.process_name Processes.process_path \nProcesses.user Processes.user_id Processes.vendor_product \n|`drop_dm_object_name(Processes)`\n| `security_content_ctime(firstTime)` \n| `security_content_ctime(lastTime)`\n| `windows_compatibility_telemetry_suspicious_child_process_filter`",
    "condition": "The detection is based on data that originates from Endpoint Detection and Response (EDR) agents. These agents are designed to provide security-related telemetry from the endpoints where the agent is installed. To implement this search, you must ingest logs that contain the process GUID, process name, and parent process. Additionally, you must ingest complete command-line executions. These logs must be processed using the appropriate Splunk Technology Add-ons that are specific to the EDR product. The logs must also be mapped to the `Processes` node of the `Endpoint` data model. Use the Splunk Common Information Model (CIM) to normalize the field names and speed up the data modeling process.",
    "fields": []
  },
  "falsepositives": [
    "None identified"
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}