{
  "id": "203ef0ea-9bd8-11eb-8201-acde48001122",
  "name": "WinEvent Scheduled Task Created to Spawn Shell",
  "description": "The following analytic detects the creation of scheduled tasks designed to execute commands using native Windows shells like PowerShell, Cmd, Wscript, or Cscript. It leverages Windows Security EventCode 4698 to identify when such tasks are registered. This activity is significant as it may indicate an attempt to establish persistence or execute malicious commands on a system. If confirmed malicious, this could allow an attacker to maintain access, execute arbitrary code, or escalate privileges, posing a severe threat to the environment.",
  "source": {
    "type": "splunk",
    "id": "203ef0ea-9bd8-11eb-8201-acde48001122",
    "url": "https://github.com/splunk/security_content/blob/develop/winevent_scheduled_task_created_to_spawn_shell.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/winevent_scheduled_task_created_to_spawn_shell.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Michael Haag, Splunk",
  "references": [
    "https://research.checkpoint.com/2021/irans-apt34-returns-with-an-updated-arsenal/",
    "https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4698",
    "https://redcanary.com/threat-detection-report/techniques/scheduled-task-job/",
    "https://docs.microsoft.com/en-us/windows/win32/taskschd/time-trigger-example--scripting-?redirectedfrom=MSDN"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`wineventlog_security` EventCode=4698 TaskContent IN (\"*powershell.exe*\", \"*wscript.exe*\", \"*cscript.exe*\", \"*cmd.exe*\", \"*sh.exe*\", \"*ksh.exe*\", \"*zsh.exe*\", \"*bash.exe*\", \"*scrcons.exe*\", \"*pwsh.exe*\") | stats count min(_time) as firstTime max(_time) as lastTime by Computer, TaskName, TaskContent | rename Computer as dest | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `winevent_scheduled_task_created_to_spawn_shell_filter`",
    "condition": "To successfully implement this search, you need to be ingesting Windows Security Event Logs with 4698 EventCode enabled. The Windows TA is also required.",
    "fields": []
  },
  "falsepositives": [
    "False positives are possible if legitimate applications are allowed to register tasks that call a shell to be spawned. Filter as needed based on command-line or processes that are used legitimately."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}