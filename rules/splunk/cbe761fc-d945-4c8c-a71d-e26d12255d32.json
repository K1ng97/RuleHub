{
  "id": "cbe761fc-d945-4c8c-a71d-e26d12255d32",
  "name": "Windows Steal Authentication Certificates - ESC1 Abuse",
  "description": "The following analytic detects when a new certificate is requested or granted against Active Directory Certificate Services (AD CS) using a Subject Alternative Name (SAN). It leverages Windows Security Event Codes 4886 and 4887 to identify these actions. This activity is significant because improperly configured certificate templates can be exploited for privilege escalation and environment compromise. If confirmed malicious, an attacker could gain elevated privileges or persist within the environment, potentially leading to unauthorized access to sensitive information and further exploitation.",
  "source": {
    "type": "splunk",
    "id": "cbe761fc-d945-4c8c-a71d-e26d12255d32",
    "url": "https://github.com/splunk/security_content/blob/develop/windows_steal_authentication_certificates___esc1_abuse.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/windows_steal_authentication_certificates___esc1_abuse.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Steven Dick",
  "references": [
    "https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf",
    "https://github.com/ly4k/Certipy#esc1",
    "https://pentestlaboratories.com/2021/11/08/threat-hunting-certificate-account-persistence/"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`wineventlog_security` EventCode IN (4886,4887) Attributes=\"*SAN:*upn*\" Attributes=\"*CertificateTemplate:*\" | stats count min(_time) as firstTime max(_time) as lastTime values(name) as name values(status) as status values(Subject) as ssl_subject values(SubjectKeyIdentifier) as ssl_hash by Computer, EventCode, Requester, Attributes, RequestId | `security_content_ctime(firstTime)`  | `security_content_ctime(lastTime)`| fillnull | rex field=Attributes \"(?i)CertificateTemplate:(?<object>[^\\r\\n]+)\" | rex field=Attributes \"(?i)ccm:(?<req_src>[^\\r\\n]+)\" | rex max_match=10 field=Attributes \"(?i)(upn=(?<req_user_1>[^\\r\\n&]+))\" | rex max_match=10 field=Attributes \"(?i)(dns=(?<req_dest_1>[^\\r\\n&]+))\" | rex field=Requester \"(.+\\\\\\\\)?(?<src_user>[^\\r\\n]+)\" | eval flavor_text = case(EventCode==\"4886\",\"A suspicious certificate was requested using request ID: \".'RequestId',EventCode==\"4887\", \"A suspicious certificate was issued using request ID: \".'RequestId'.\". To revoke this certifacte use this request ID or the SSL fingerprint [\".'ssl_hash'.\"]\"), dest = upper(coalesce(req_dest_1,req_dest_2)), src = upper(coalesce(req_src,Computer)) | fields - req_* | rename Attributes as object_attrs, EventCode as signature_id, name as signature, RequestId as ssl_serial, Requester as ssl_subject_common_name| `windows_steal_authentication_certificates___esc1_abuse_filter`",
    "condition": "To implement this analytic, enhanced Audit Logging must be enabled on AD CS and within Group Policy Management for CS server. See Page 115 of first reference. Recommend throttle correlation by RequestId/ssl_serial at minimum.",
    "fields": []
  },
  "falsepositives": [
    "False positives may be generated in environments where administrative users or processes are allowed to generate certificates with Subject Alternative Names. Sources or templates used in these processes may need to be tuned out for accurate function."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}