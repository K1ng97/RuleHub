{
  "id": "d77d349e-6269-11ec-9cfe-acde48001122",
  "name": "Suspicious Ticket Granting Ticket Request",
  "description": "The following analytic detects suspicious Kerberos Ticket Granting Ticket (TGT) requests that may indicate exploitation of CVE-2021-42278 and CVE-2021-42287. It leverages Event ID 4781 (account name change) and Event ID 4768 (TGT request) to identify sequences where a newly renamed computer account requests a TGT. This behavior is significant as it could represent an attempt to escalate privileges by impersonating a Domain Controller. If confirmed malicious, this activity could allow attackers to gain elevated access and potentially control over the domain environment.",
  "source": {
    "type": "splunk",
    "id": "d77d349e-6269-11ec-9cfe-acde48001122",
    "url": "https://github.com/splunk/security_content/blob/develop/suspicious_ticket_granting_ticket_request.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/suspicious_ticket_granting_ticket_request.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Mauricio Velazco, Splunk",
  "references": [
    "https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html",
    "https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42278",
    "https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42287"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`wineventlog_security` (EventCode=4781 OldTargetUserName=\"*$\" NewTargetUserName!=\"*$\") OR (EventCode=4768 TargetUserName!=\"*$\") | eval RenamedComputerAccount = coalesce(NewTargetUserName, TargetUserName) | transaction RenamedComputerAccount startswith=(EventCode=4781) endswith=(EventCode=4768) | eval short_lived=case((duration<2),\"TRUE\") | search short_lived = TRUE | table _time, Computer, EventCode, TargetUserName, RenamedComputerAccount, short_lived | rename Computer as dest | `suspicious_ticket_granting_ticket_request_filter`",
    "condition": "To successfully implement this search, you need to be ingesting Domain Controller and Kerberos events. The Advanced Security Audit policy setting `Audit Kerberos Authentication Service` within `Account Logon` needs to be enabled.",
    "fields": []
  },
  "falsepositives": [
    "A computer account name change event inmediately followed by a kerberos TGT request with matching fields is unsual. However, legitimate behavior may trigger it. Filter as needed."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}