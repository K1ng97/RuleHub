{
  "id": "5fde0b7c-df7a-40b1-9b3a-294c00f0289d",
  "name": "Windows AD Same Domain SID History Addition",
  "description": "The following analytic detects changes to the sIDHistory attribute of user or computer objects within the same domain. It leverages Windows Security Event Codes 4738 and 4742 to identify when the sIDHistory attribute is modified. This activity is significant because the sIDHistory attribute can be abused by adversaries to grant unauthorized access by inheriting permissions from another account. If confirmed malicious, this could allow attackers to maintain persistent access or escalate privileges within the domain, posing a severe security risk.",
  "source": {
    "type": "splunk",
    "id": "5fde0b7c-df7a-40b1-9b3a-294c00f0289d",
    "url": "https://github.com/splunk/security_content/blob/develop/windows_ad_same_domain_sid_history_addition.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/windows_ad_same_domain_sid_history_addition.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Dean Luxton",
  "references": [
    "https://adsecurity.org/?p=1772",
    "https://learn.microsoft.com/en-us/windows/win32/adschema/a-sidhistory?redirectedfrom=MSDN",
    "https://learn.microsoft.com/en-us/defender-for-identity/security-assessment-unsecure-sid-history-attribute",
    "https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/sid-history-injection"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`wineventlog_security` (EventCode=4742 OR EventCode=4738) NOT SidHistory IN (\"%%1793\", -) | rex field=SidHistory \"(^%{|^)(?P<SidHistoryMatch>.*)(\\-|\\\\\\)\" | rex field=TargetSid \"^(?P<TargetSidmatch>.*)(\\-|\\\\\\)\" | where SidHistoryMatch=TargetSidmatch OR SidHistoryMatch=TargetDomainName | rename TargetSid as userSid, TargetDomainName as userDomainName | table _time action status host user userSid userDomainName SidHistory Logon_ID src_user dest | `windows_ad_same_domain_sid_history_addition_filter`",
    "condition": "To successfully implement this search, you need to be ingesting eventcodes `4738` and `4742`. The Advanced Security Audit policy settings `Audit User Account Management` and  `Audit Computer Account Management` within `Account Management` all need to be enabled. SID resolution is not required..",
    "fields": []
  },
  "falsepositives": [
    "Unknown"
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}