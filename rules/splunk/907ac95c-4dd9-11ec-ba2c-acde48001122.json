{
  "id": "907ac95c-4dd9-11ec-ba2c-acde48001122",
  "name": "Powershell Windows Defender Exclusion Commands",
  "description": "The following analytic detects the use of PowerShell commands to add or set Windows Defender exclusions. It leverages EventCode 4104 to identify suspicious `Add-MpPreference` or `Set-MpPreference` commands with exclusion parameters. This activity is significant because adversaries often use it to bypass Windows Defender, allowing malicious code to execute without detection. If confirmed malicious, this behavior could enable attackers to evade antivirus defenses, maintain persistence, and execute further malicious activities undetected.",
  "source": {
    "type": "splunk",
    "id": "907ac95c-4dd9-11ec-ba2c-acde48001122",
    "url": "https://github.com/splunk/security_content/blob/develop/powershell_windows_defender_exclusion_commands.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/powershell_windows_defender_exclusion_commands.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Teoderick Contreras, Splunk",
  "references": [
    "https://tccontre.blogspot.com/2020/01/remcos-rat-evading-windows-defender-av.html",
    "https://app.any.run/tasks/cf1245de-06a7-4366-8209-8e3006f2bfe5/",
    "https://www.microsoft.com/security/blog/2022/01/15/destructive-malware-targeting-ukrainian-organizations/"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`powershell` EventCode=4104 (ScriptBlockText = \"*Add-MpPreference *\" OR ScriptBlockText = \"*Set-MpPreference *\") AND ScriptBlockText = \"*-exclusion*\" | fillnull | stats count min(_time) as firstTime max(_time) as lastTime by dest signature signature_id user_id vendor_product EventID Guid Opcode Name Path ProcessID ScriptBlockId ScriptBlockText | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | `powershell_windows_defender_exclusion_commands_filter`",
    "condition": "To successfully implement this search you need to be ingesting information on process that include the name of the process responsible for the changes from your endpoints into the `Endpoint` datamodel in the `Registry` node. Also make sure that this registry was included in your config files ex. sysmon config to be monitored.",
    "fields": []
  },
  "falsepositives": [
    "admin or user may choose to use this windows features."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}