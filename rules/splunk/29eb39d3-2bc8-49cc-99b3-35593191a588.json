{
  "id": "29eb39d3-2bc8-49cc-99b3-35593191a588",
  "name": "Azure AD Service Principal Privilege Escalation",
  "description": "This detection identifies when an Azure Service Principal elevates privileges by adding themself to a new app role assignment.",
  "source": {
    "type": "splunk",
    "id": "29eb39d3-2bc8-49cc-99b3-35593191a588",
    "url": "https://github.com/splunk/security_content/blob/develop/azure_ad_service_principal_privilege_escalation.yml",
    "file_path": "tmp/repos/splunk/detections/cloud/azure_ad_service_principal_privilege_escalation.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Dean Luxton",
  "references": [
    "https://splunkbase.splunk.com/app/3110",
    "https://docs.splunk.com/Documentation/AddOns/released/MSCloudServices/Install",
    "https://github.com/mvelazc0/BadZure",
    "https://www.splunk.com/en_us/blog/security/hunting-m365-invaders-navigating-the-shadows-of-midnight-blizzard.html",
    "https://posts.specterops.io/microsoft-breach-what-happened-what-should-azure-admins-do-da2b7e674ebc"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`azure_monitor_aad` category=AuditLogs operationName=\"Add app role assignment to service principal\" properties.initiatedBy.app.displayName=* properties.result=Success  | spath path=properties{}.targetResources{}.modifiedProperties{} output=targetResources  | rename properties.* as *  | eval user=\"NA\"  | eval src=\"NA\"  | stats min(_time) as firstTime max(_time) as lastTime values(eval(mvfilter(match(targetResources, \"AppRole.Value\")))) as appRole, values(eval(mvfilter(match(targetResources, \"ServicePrincipal.DisplayName\")))) as targetServicePrincipal values(eval(mvindex('properties.targetResources{}.displayName',0))) as targetAppContext  values(user_agent) as user_agent values(identity) as servicePrincipal values(properties.initiatedBy.app.servicePrincipalId) as servicePrincipalId by dest user src vendor_account vendor_product signature | spath input=appRole path=newValue output=appRole  | spath input=targetServicePrincipal path=newValue output=targetServicePrincipal  | eval appRole=trim(replace(appRole, \"\\\"\", \"\")), targetServicePrincipal=trim(replace(targetServicePrincipal, \"\\\"\", \"\"))  | where servicePrincipal=targetServicePrincipal  | `security_content_ctime(firstTime)`  | `security_content_ctime(lastTime)` | `azure_ad_service_principal_privilege_escalation_filter`",
    "condition": "The Splunk Add-on for Microsoft Cloud Services add-on is required to ingest EntraID audit logs via Azure EventHub. See reference for links for further details on how to onboard this log source.",
    "fields": []
  },
  "falsepositives": [
    "Unknown"
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}