{
  "id": "57551656-ebdb-11eb-afdf-acde48001122",
  "name": "SAM Database File Access Attempt",
  "description": "The following analytic detects attempts to access the SAM, SYSTEM, or SECURITY database files within the `windows\\system32\\config` directory using Windows Security EventCode 4663. This detection leverages Windows Security Event logs to identify unauthorized access attempts. Monitoring this activity is crucial as it indicates potential credential access attempts, possibly exploiting vulnerabilities like CVE-2021-36934. If confirmed malicious, an attacker could extract user passwords, leading to unauthorized access, privilege escalation, and further compromise of the system.",
  "source": {
    "type": "splunk",
    "id": "57551656-ebdb-11eb-afdf-acde48001122",
    "url": "https://github.com/splunk/security_content/blob/develop/sam_database_file_access_attempt.yml",
    "file_path": "tmp/repos/splunk/detections/endpoint/sam_database_file_access_attempt.yml"
  },
  "tags": [
    "analytic_story",
    "asset_type",
    "cve",
    "mitre_attack_id",
    "product",
    "security_domain"
  ],
  "author": "Michael Haag, Mauricio Velazco, Splunk",
  "references": [
    "https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4663",
    "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4663",
    "https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934",
    "https://github.com/GossiTheDog/HiveNightmare",
    "https://github.com/JumpsecLabs/Guidance-Advice/tree/main/SAM_Permissions",
    "https://en.wikipedia.org/wiki/Security_Account_Manager"
  ],
  "severity": "medium",
  "type": "splunk",
  "status": "production",
  "created": "2025-05-02",
  "modified": "2025-05-02",
  "mitre": {
    "tactics": [],
    "techniques": []
  },
  "detection": {
    "query": "`wineventlog_security` (EventCode=4663)  ProcessName!=*\\\\dllhost.exe ObjectName IN (\"*\\\\Windows\\\\System32\\\\config\\\\SAM*\",\"*\\\\Windows\\\\System32\\\\config\\\\SYSTEM*\",\"*\\\\Windows\\\\System32\\\\config\\\\SECURITY*\") | stats values(AccessList) count by ProcessName ObjectName dest src_user | rename ProcessName as process_name | `sam_database_file_access_attempt_filter`",
    "condition": "To successfully implement this search, you must ingest Windows Security Event logs and track event code 4663. For 4663, enable \"Audit Object Access\" in Group Policy. Then check the two boxes listed for both \"Success\" and \"Failure.\"",
    "fields": []
  },
  "falsepositives": [
    "Natively, `dllhost.exe` will access the files. Every environment will have additional native processes that do as well. Filter by process_name. As an aside, one can remove process_name entirely and add `Object_Name=*ShadowCopy*`."
  ],
  "level": "medium",
  "rule_format": "standard",
  "platforms": [],
  "data_sources": []
}